<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',      
                            card: '#1e293b',    
                            border: '#334155',  
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #cbd5e1; }
        .hidden-section { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Login Shake */
        @keyframes shake {
            0%, 100% { transform: translateX(0); border-color: #334155; }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); border-color: #ef4444; }
            20%, 40%, 60%, 80% { transform: translateX(4px); border-color: #ef4444; }
        }
        .shake-anim { animation: shake 0.4s ease-in-out; }

        /* Staggered Animations */
        .stagger-1 { animation-delay: 100ms; }
        .stagger-2 { animation-delay: 200ms; }
        .stagger-3 { animation-delay: 300ms; }
        .stagger-4 { animation-delay: 400ms; }
        .stagger-5 { animation-delay: 500ms; }

        /* Table Row Hover Transition */
        tr { transition: background-color 0.2s ease; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col selection:bg-blue-500 selection:text-white">

    <div id="login-gate" class="fixed inset-0 z-50 bg-[#0f172a] flex flex-col items-center justify-center transition-all duration-700 ease-in-out">
        <div class="w-full max-w-sm p-8 bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 transform transition-all hover:scale-[1.01] duration-300">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-blue-500/10 text-blue-400 mb-4 ring-1 ring-blue-500/20 animate-pulse-slow">
                    <i class="fas fa-fingerprint text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-100 tracking-tight">Secure Vault</h1>
                <p class="text-slate-500 text-xs mt-2 uppercase tracking-widest font-semibold">AES-256 Encrypted</p>
            </div>
            
            <div class="space-y-4">
                <div class="relative group">
                    <input type="password" id="password-input" 
                        class="w-full bg-slate-900 border border-slate-700 rounded-xl py-3.5 px-4 text-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all placeholder-slate-600 shadow-inner"
                        placeholder="Enter Master Key">
                    <button onclick="togglePassVisibility()" class="absolute right-3 top-4 text-slate-500 hover:text-white transition transform hover:scale-110 active:scale-95">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
                <button onclick="attemptLogin()" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-blue-900/40 hover:shadow-blue-600/40 transform active:scale-95">
                    Unlock Dashboard
                </button>
            </div>
            
            <div id="login-status" class="text-center text-xs mt-6 text-slate-500 min-h-[20px] flex items-center justify-center gap-2 font-mono">
                <i class="fas fa-circle-notch fa-spin"></i> Establishing Uplink...
            </div>
        </div>
    </div>

    <div id="dashboard-ui" class="hidden-section flex-1 flex flex-col h-screen overflow-hidden opacity-0">
        
        <header class="bg-slate-800/90 backdrop-blur-md border-b border-slate-700 z-20 shrink-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3 group cursor-default">
                    <div class="bg-blue-600/20 p-2 rounded-lg text-blue-400 group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                        <i class="fas fa-cube text-lg"></i>
                    </div>
                    <span class="font-bold text-lg text-slate-100 tracking-tight">Loan<span class="text-slate-500 font-light">Tracker</span></span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-lg shadow-blue-900/30 hover:shadow-blue-500/30 transform active:scale-95 flex items-center gap-2">
                        <i class="fas fa-plus"></i> <span class="hidden sm:inline">Add Entry</span>
                    </button>
                    <button onclick="logout()" class="text-slate-400 hover:text-red-400 p-2 rounded-lg hover:bg-slate-700/50 transition-all active:rotate-90" title="Lock Vault">
                        <i class="fas fa-power-off text-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-slate-900 p-4 sm:p-6 lg:p-8 custom-scroll">
            <div class="max-w-7xl mx-auto space-y-6">

                <div class="opacity-0 animate-fade-in-up stagger-1 bg-slate-800 rounded-xl shadow-lg border border-slate-700 p-4 sticky top-0 z-10 backdrop-blur-sm bg-slate-800/95 transition-all focus-within:border-blue-500/50 focus-within:ring-1 focus-within:ring-blue-500/20">
                    <div class="flex flex-col xl:flex-row gap-4 justify-between items-center">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 w-full xl:w-auto flex-1">
                            <input type="date" id="filter-start" onchange="applyFilters()" class="w-full text-sm bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none h-11 transition-colors [color-scheme:dark] cursor-pointer hover:bg-slate-700/50">
                            
                            <input type="date" id="filter-end" onchange="applyFilters()" class="w-full text-sm bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none h-11 transition-colors [color-scheme:dark] cursor-pointer hover:bg-slate-700/50">
                            
                            <select id="filter-type" onchange="applyFilters()" class="w-full text-sm bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none h-11 transition-colors cursor-pointer hover:bg-slate-700/50">
                                <option value="all">All Types</option>
                                <option value="loan">Loan Spend</option>
                                <option value="personal">Personal Spend</option>
                            </select>
                            
                            <select id="filter-payee" onchange="applyFilters()" class="w-full text-sm bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none h-11 transition-colors cursor-pointer hover:bg-slate-700/50">
                                <option value="all">All Payees</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3 w-full xl:w-auto items-center">
                            <div class="relative flex-1 xl:w-64 group">
                                <i class="fas fa-search absolute left-3 top-3.5 text-slate-500 text-xs transition-colors group-focus-within:text-blue-400"></i>
                                <input type="text" id="table-search" onkeyup="applyFilters()" placeholder="Search transactions..." class="w-full bg-slate-900 border border-slate-700 rounded-lg py-2.5 pl-9 pr-3 text-sm text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none h-11 transition-all">
                            </div>
                            <button onclick="resetFilters()" class="text-sm font-medium text-blue-400 hover:text-blue-300 hover:bg-blue-400/10 px-3 py-2 rounded-lg transition-colors whitespace-nowrap active:scale-95">Reset</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 opacity-0 animate-fade-in-up stagger-2">
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 border-l-4 border-l-purple-500 relative overflow-hidden group hover:-translate-y-1 hover:shadow-xl hover:shadow-purple-500/10 transition-all duration-300">
                        <div class="absolute -right-6 -bottom-6 bg-purple-500/10 w-24 h-24 rounded-full blur-xl group-hover:bg-purple-500/20 transition-all duration-500"></div>
                        <p class="text-xs font-bold text-purple-400 uppercase tracking-wider relative z-10">Land / Plot Cost</p>
                        <p id="val-plot" class="text-3xl font-bold text-slate-100 mt-2 relative z-10 tracking-tight">...</p>
                        <p class="text-xs text-slate-500 mt-1 relative z-10">Fixed Asset Investment</p>
                    </div>

                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 border-l-4 border-l-emerald-500 md:col-span-2 relative overflow-hidden group hover:-translate-y-1 hover:shadow-xl hover:shadow-emerald-500/10 transition-all duration-300">
                        <div class="absolute -right-6 -top-6 bg-emerald-500/10 w-32 h-32 rounded-full blur-xl group-hover:bg-emerald-500/20 transition-all duration-500"></div>
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center relative z-10 h-full">
                            <div class="space-y-4">
                                <p class="text-xs font-bold text-emerald-400 uppercase tracking-wider">Cash Flow Status</p>
                                <div class="flex gap-8 text-sm">
                                    <div class="group/item">
                                        <p class="text-slate-500 text-xs mb-1">Disbursed (In)</p>
                                        <p id="val-disbursed" class="font-mono text-slate-200 text-lg group-hover/item:text-white transition-colors">₹0</p>
                                    </div>
                                    <div class="w-px bg-slate-700"></div>
                                    <div class="group/item">
                                        <p class="text-slate-500 text-xs mb-1">Spent (Material)</p>
                                        <p id="val-spent-materials" class="font-mono text-red-400 text-lg group-hover/item:text-red-300 transition-colors">₹0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 md:mt-0 text-right">
                                <p class="text-xs text-slate-400 font-bold uppercase mb-1">Cash In Hand</p>
                                <p id="val-balance" class="text-4xl font-bold text-white tracking-tight drop-shadow-sm">₹0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="opacity-0 animate-fade-in-up stagger-3 bg-slate-800 p-6 rounded-xl border border-slate-700 hover:border-slate-600 transition-colors">
                    <div class="flex justify-between items-end mb-3">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Loan Utilization</p>
                        <span id="limit-text" class="text-sm font-bold text-blue-400 bg-blue-400/10 px-2 py-1 rounded">0% Used</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden mb-3 shadow-inner">
                        <div id="limit-bar" class="bg-blue-500 h-full rounded-full shadow-[0_0_15px_rgba(59,130,246,0.5)] relative overflow-hidden transition-all duration-1000 ease-out w-0">
                            <div class="absolute top-0 left-0 w-full h-full bg-white/20 -skew-x-12"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs font-mono">
                        <span class="text-slate-500">Used: <strong id="val-total-used" class="text-slate-300">₹0</strong></span>
                        <span class="text-slate-500">Limit: <strong id="val-limit" class="text-slate-300">₹0</strong></span>
                        <span class="text-emerald-400">Left: <strong id="val-limit-remaining">₹0</strong></span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 opacity-0 animate-fade-in-up stagger-4">
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex flex-col justify-center hover:border-slate-600 transition-all">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Filtered View</p>
                        <div class="mb-6">
                            <p class="text-3xl font-bold text-white" id="kpi-filtered-total">₹0</p>
                            <p class="text-xs text-blue-400 font-medium">Total Selected</p>
                        </div>
                        <div>
                            <p class="text-xl font-bold text-white" id="kpi-count">0</p>
                            <p class="text-xs text-slate-500">Transactions Found</p>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 lg:col-span-2 relative">
                        <h3 class="font-bold text-slate-300 text-sm mb-4">Spending Trend</h3>
                        <div class="h-64 relative w-full">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="opacity-0 animate-fade-in-up stagger-5 bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="bg-slate-800/80 px-6 py-4 border-b border-slate-700 backdrop-blur">
                        <h3 class="font-bold text-slate-200 text-sm">Transaction History</h3>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] custom-scroll">
                        <table class="min-w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-900/50 sticky top-0 z-10 backdrop-blur-sm">
                                <tr>
                                    <th class="px-6 py-3 font-semibold tracking-wider">Date</th>
                                    <th class="px-6 py-3 font-semibold tracking-wider">Type</th>
                                    <th class="px-6 py-3 font-semibold tracking-wider">Payee</th>
                                    <th class="px-6 py-3 font-semibold tracking-wider">Desc</th>
                                    <th class="px-6 py-3 font-semibold tracking-wider text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-700 bg-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal" class="hidden-section fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm transition-opacity duration-300 cursor-pointer" onclick="closeModal()"></div>
        
        <div id="modal-content" class="relative bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800">
                <h3 class="font-bold text-lg text-slate-200 pl-2">Add Transaction</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-400 text-slate-300 flex items-center justify-center transition-all active:scale-90">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 bg-white relative"> 
                <iframe id="form-iframe" class="w-full h-full" frameborder="0" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const DATA_URL = 'https://donypsaju.github.io/dreamHome/data.json'; 
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScBerkKLjK0Vbn_tN6mTIOmswBQ-rvmm1gzk3H-OYs9BsqunQ/viewform"; 

        // STATE
        let RAW_DATA = { meta: {}, expenses: [] };
        let FILTERED_DATA = [];
        let chartInstances = {};
        let encryptedBlob = null;
        let previousBalances = {}; // For number animation

        // --- ANIMATION UTILS ---
        function animateValue(obj, start, end, duration, prefix = "₹") {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // Easing function (Ease Out Quart)
                const ease = 1 - Math.pow(1 - progress, 4);
                
                const current = Math.floor(progress * (end - start) + start);
                obj.innerHTML = prefix + current.toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerHTML = prefix + end.toLocaleString();
                }
            };
            window.requestAnimationFrame(step);
        }

        function animateTextUpdate(elementId, value, prefix="₹") {
            const el = document.getElementById(elementId);
            // Simple parsing of current value "₹1,200" -> 1200
            let start = parseInt(el.innerText.replace(/[^0-9-]/g, '')) || 0;
            if(isNaN(start)) start = 0;
            
            // Only animate if difference is significant
            if(start !== value) {
                animateValue(el, start, value, 800, prefix);
            }
        }

        // --- INIT ---
        window.onload = async () => {
            const status = document.getElementById('login-status');
            const savedKey = localStorage.getItem('vaultKey');
            if(savedKey) document.getElementById('password-input').value = savedKey;

            try {
                const res = await fetch(DATA_URL + "?t=" + Date.now());
                if(!res.ok) throw new Error("404");
                encryptedBlob = await res.text();
                if(encryptedBlob.startsWith('"')) encryptedBlob = encryptedBlob.slice(1, -1);
                
                status.innerHTML = `<span class="text-emerald-400 font-semibold animate-pulse"><i class="fas fa-wifi"></i> Secure Connection Ready</span>`;
                
                if(savedKey) attemptLogin();
            } catch (e) {
                status.innerHTML = `<span class="text-red-400">Connection Failed. Check URL.</span>`;
            }
        };

        // --- AUTH ---
        function attemptLogin() {
            const key = document.getElementById('password-input').value;
            const btn = document.getElementById('login-btn');
            
            if(!encryptedBlob) return;
            
            // UI Feedback
            btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> Decrypting...`;
            btn.classList.add('cursor-wait', 'opacity-80');

            setTimeout(() => {
                try {
                    const bytes = CryptoJS.AES.decrypt(encryptedBlob, key);
                    const str = bytes.toString(CryptoJS.enc.Utf8);
                    if(!str) throw new Error();

                    RAW_DATA = JSON.parse(str);
                    localStorage.setItem('vaultKey', key);

                    // Login Exit Animation
                    const gate = document.getElementById('login-gate');
                    gate.style.opacity = '0';
                    gate.style.transform = 'scale(1.05)';
                    
                    setTimeout(() => {
                        gate.classList.add('hidden-section');
                        const dash = document.getElementById('dashboard-ui');
                        dash.classList.remove('hidden-section');
                        
                        // Trigger CSS Animations
                        dash.classList.add('opacity-100'); // Triggers the cascade
                        
                        initDashboard();
                    }, 500);

                } catch (e) {
                    const input = document.getElementById('password-input');
                    input.classList.add('shake-anim');
                    input.value = "";
                    input.placeholder = "Incorrect Key";
                    btn.innerHTML = "Unlock Dashboard";
                    btn.classList.remove('cursor-wait', 'opacity-80');
                    localStorage.removeItem('vaultKey');
                    setTimeout(() => input.classList.remove('shake-anim'), 500);
                }
            }, 300); // Slight artificial delay for effect
        }

        function logout() { 
            const dash = document.getElementById('dashboard-ui');
            dash.style.opacity = '0';
            dash.style.transform = 'translateY(20px)';
            setTimeout(() => {
                localStorage.removeItem('vaultKey'); 
                location.reload(); 
            }, 300);
        }

        function togglePassVisibility() {
            const input = document.getElementById('password-input');
            input.type = input.type === "password" ? "text" : "password";
        }

        // --- DASHBOARD ---
        function initDashboard() {
            const payees = new Set();
            (RAW_DATA.expenses || []).forEach(r => {
                const p = r.Payee || r.Payee_Name;
                if(p) payees.add(p.trim());
            });
            const ps = document.getElementById('filter-payee');
            ps.innerHTML = '<option value="all">All Payees</option>';
            [...payees].sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.innerText = p; ps.appendChild(opt);
            });
            applyFilters();
        }

        function applyFilters() {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const type = document.getElementById('filter-type').value;
            const payee = document.getElementById('filter-payee').value;
            const search = document.getElementById('table-search').value.toLowerCase();

            FILTERED_DATA = (RAW_DATA.expenses || []).filter(row => {
                const rDate = new Date(row.Date);
                const rType = (row.Type || "").toLowerCase();
                const rPayee = (row.Payee || row.Payee_Name || "").toLowerCase();
                const rDesc = (row.Description || "").toLowerCase();
                const rAmt = (row.Amount || "").toString();

                if(start && rDate < new Date(start)) return false;
                if(end && rDate > new Date(end)) return false;
                if(type === 'loan' && !rType.includes('loan')) return false;
                if(type === 'personal' && rType.includes('loan')) return false;
                if(payee !== 'all' && rPayee !== payee.toLowerCase()) return false;
                if(search && !rDesc.includes(search) && !rPayee.includes(search) && !rAmt.includes(search)) return false;
                return true;
            });

            FILTERED_DATA.sort((a,b) => new Date(b.Date) - new Date(a.Date));
            updateUI();
        }

        function resetFilters() {
            document.getElementById('filter-start').value = '';
            document.getElementById('filter-end').value = '';
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-payee').value = 'all';
            document.getElementById('table-search').value = '';
            applyFilters();
        }

        function updateUI() {
            const meta = RAW_DATA.meta || {};
            const sanctioned = parseFloat(meta.Sanctioned_Amount) || 0;
            const disbursed = parseFloat(meta.Disbursed_Amount) || 0;
            const plotCost = parseFloat(meta.Plot_Cost) || 0;

            const filteredTotal = FILTERED_DATA.reduce((sum, r) => sum + (parseFloat(r.Amount)||0), 0);
            
            // ANIMATE NUMBERS instead of instant set
            animateTextUpdate('kpi-filtered-total', filteredTotal);
            animateTextUpdate('kpi-count', FILTERED_DATA.length, "");

            const allRows = RAW_DATA.expenses || [];
            const totalMaterialLoanSpend = allRows.reduce((sum, r) => {
                return (r.Type||"").toLowerCase().includes('loan') ? sum + (parseFloat(r.Amount)||0) : sum;
            }, 0);

            const cashInHand = disbursed - totalMaterialLoanSpend;
            const totalDebt = totalMaterialLoanSpend + plotCost;
            const remainingSanctioned = sanctioned - totalDebt;

            animateTextUpdate('val-plot', plotCost);
            animateTextUpdate('val-disbursed', disbursed);
            // For spent, we want negative formatting
            const spentEl = document.getElementById('val-spent-materials');
            const currentSpent = parseInt(spentEl.innerText.replace(/[^0-9-]/g, '')) || 0;
            animateValue(spentEl, currentSpent, -totalMaterialLoanSpend, 800, "- ₹");

            const balEl = document.getElementById('val-balance');
            animateValue(balEl, parseInt(balEl.innerText.replace(/[^0-9-]/g, '')) || 0, cashInHand, 800);
            
            // Color Logic for Balance
            setTimeout(() => {
                balEl.className = `text-4xl font-bold tracking-tight drop-shadow-sm transition-colors duration-500 ${cashInHand < 50000 ? 'text-red-400' : 'text-emerald-400'}`;
            }, 0);

            // Progress Bar Animation
            const pct = sanctioned > 0 ? Math.min(100, (totalDebt / sanctioned) * 100) : 0;
            const bar = document.getElementById('limit-bar');
            bar.style.width = pct + "%";
            bar.className = `h-full rounded-full shadow-[0_0_15px_rgba(59,130,246,0.5)] relative overflow-hidden transition-all duration-1000 ease-out ${pct > 90 ? 'bg-red-500 shadow-red-500/50' : 'bg-blue-500'}`;
            
            document.getElementById('limit-text').innerText = pct.toFixed(1) + "% Used";
            animateTextUpdate('val-total-used', totalDebt);
            animateTextUpdate('val-limit', sanctioned);
            animateTextUpdate('val-limit-remaining', remainingSanctioned);

            // Table Update with Fade Effect
            const tbody = document.getElementById('table-body');
            tbody.style.opacity = '0.5'; // dimmed while updating
            
            setTimeout(() => {
                tbody.innerHTML = '';
                FILTERED_DATA.forEach((row, index) => {
                    const isLoan = (row.Type||"").toLowerCase().includes('loan');
                    const tr = document.createElement('tr');
                    // Add slight delay to each row for cascade effect
                    tr.className = "hover:bg-slate-700/50 transition duration-150 border-b border-slate-700 last:border-0 group animate-fade-in-up";
                    tr.style.animationDelay = (index * 20) + 'ms'; // Very fast cascade
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-slate-300 font-medium">${row.Date}</td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 text-xs font-bold rounded-full border ${isLoan ? 'bg-red-500/10 text-red-400 border-red-500/20' : 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20'}">
                                ${row.Type}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-400 group-hover:text-slate-200 transition-colors">${row.Payee || row.Payee_Name || '-'}</td>
                        <td class="px-6 py-4 text-slate-500 max-w-xs truncate group-hover:text-slate-400 transition-colors" title="${row.Description || ''}">${row.Description || '-'}</td>
                        <td class="px-6 py-4 text-right font-mono font-bold text-slate-300">₹${Number(row.Amount).toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
                tbody.style.opacity = '1';
            }, 150);

            updateCharts();
        }

        function updateCharts() {
            const sorted = [...FILTERED_DATA].sort((a,b) => new Date(a.Date) - new Date(b.Date));
            const dateMap = {};
            sorted.forEach(r => {
                const d = r.Date;
                dateMap[d] = (dateMap[d] || 0) + (parseFloat(r.Amount)||0);
            });
            const labels = Object.keys(dateMap);
            const data = Object.values(dateMap);

            if(chartInstances.timeline) chartInstances.timeline.destroy();

            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = '#334155';
            
            const ctx = document.getElementById('timelineChart').getContext('2d');
            chartInstances.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spending',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
                            return gradient;
                        },
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4, // Smooth curves
                        pointBackgroundColor: '#1e293b',
                        pointBorderColor: '#3b82f6',
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#3b82f6',
                        pointHoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, border: { display: false }, grid: { color: '#334155', tickLength: 0 } }
                    }
                }
            });
        }

        // --- MODAL ANIMATION ---
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const iframe = document.getElementById('form-iframe');

        function openModal() {
            modal.classList.remove('hidden-section');
            if(iframe.src === 'about:blank') iframe.src = FORM_URL;
            
            // Trigger animation frame
            requestAnimationFrame(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            });
        }

        function closeModal() { 
            // Reverse animation
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden-section');
            }, 300);
        }
    </script>
</body>
</html>